# Service file for HTTPS authenticating proxy for use with
# exodus-gw sidecar.
#
# This unit was initially generated by "podman generate systemd",
# then extended with additional required steps and options.

[Unit]
Description=exodus-gw sidecar HTTPS proxy
Wants=network.target exodus-gw-uvicorn.service exodus-gw-cert.service
After=network-online.target

[Service]
EnvironmentFile=-%E/exodus-gw-dev/.env
Environment=EXODUS_GW_HTTP_PORT=8000
Environment=EXODUS_GW_HTTPS_PORT=8010
Environment=EXODUS_GW_SIDECAR_IMAGE=images.paas.redhat.com/it-platform/platform-sidecar:3.2.9.7df47cc

Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure

# Make properties file
ExecStartPre=sh -c "cat >%E/exodus-gw-dev/platform-sidecar.yaml <<END\n\
server.ssl.client-auth: want\n\
server.port: ${EXODUS_GW_HTTPS_PORT}\n\
com.redhat.api.platform:\n\
 http.server:\n\
  proxy.target: http://localhost:${EXODUS_GW_HTTP_PORT}\n\
  use-default-authorities: false\n\
  public-certificate-x509-pem:\
|\n$(sed -r -e 's|^|    |' %E/exodus-gw-dev/service.pem)\n\
  private-key-pkcs8-pem:\
|\n$(sed -r -e 's|^|    |' %E/exodus-gw-dev/service-key.pem)\n\
 security:\n\
  roles:\n\
   test-blob-uploader:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
   test-publisher:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
   test-config-deployer:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
   test-config-consumer:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
   test-cdn-consumer:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
   test-cdn-flusher:\n\
    users:\n\
     byInternalUsername: [${USER}]\n\
\nEND\n\
"

# Remove existing container if it's already there
ExecStartPre=-/usr/bin/podman rm --ignore -f --cidfile %t/%n-cid

ExecStartPre=/usr/bin/rm -f %t/%n-pid %t/%n-cid
ExecStart=/usr/bin/podman run --conmon-pidfile %t/%n-pid --cidfile %t/%n-cid --cgroups=no-conmon -d --name exodus-gw-sidecar --network host\
  --log-driver journald\
  -v %E/exodus-gw-dev:/opt/app/config:z\
  ${EXODUS_GW_SIDECAR_IMAGE}
ExecStop=/usr/bin/podman stop --ignore --cidfile %t/%n-cid -t 10
ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/%n-cid
PIDFile=%t/%n-pid
TimeoutStopSec=60
Type=forking

[Install]
WantedBy=exodus-gw.target
